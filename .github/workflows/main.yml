# 文件: .github/workflows/build_twrp_fixed.yml
name: Build TWRP Recovery (Fixed)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 100
    
    steps:
    - name: Checkout device tree
      uses: actions/checkout@v4
      
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git-core python3 python-is-python3 curl \
          openjdk-11-jdk ccache bc libssl-dev \
          android-sdk-libsparse-utils abootimg
        
        curl -s https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
        chmod +x ~/repo
        sed -i '1s/python$/python3/' ~/repo
        
    - name: Prepare TWRP build environment
      run: |
        mkdir -p twrp-build/device/xiaomi/selene
        mkdir -p twrp-build/vendor/xiaomi/selene
        
        # 复制所有设备树文件
        cp -r * twrp-build/device/xiaomi/selene/ 2>/dev/null || true
        rm -rf twrp-build/device/xiaomi/selene/.github twrp-build/device/xiaomi/selene/.git 2>/dev/null || true
        
    - name: Clone TWRP sources
      run: |
        cd twrp-build
        
        echo "正在初始化 TWRP 源码..."
        ~/repo init -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git \
          -b twrp-12.1 \
          --depth=1
        
        # 添加设备树到本地清单
        mkdir -p .repo/local_manifests
        echo '<?xml version="1.0" encoding="UTF-8"?>' > .repo/local_manifests/selene.xml
        echo '<manifest>' >> .repo/local_manifests/selene.xml
        echo '  <!-- 添加设备树 -->' >> .repo/local_manifests/selene.xml
        echo '  <project path="device/xiaomi/selene" name="device-xiaomi-selene" remote="github" />' >> .repo/local_manifests/selene.xml
        echo '  <project path="vendor/xiaomi/selene" name="vendor-xiaomi-selene" remote="github" />' >> .repo/local_manifests/selene.xml
        echo '</manifest>' >> .repo/local_manifests/selene.xml
        
        echo "正在同步源码..."
        ~/repo sync -c --force-sync --no-clone-bundle --no-tags --optimized-fetch --prune -j4
        
    - name: Setup device tree
      run: |
        cd twrp-build
        
        echo "设置设备树..."
        if [ -f "device/xiaomi/selene/vendorsetup.sh" ]; then
          echo "使用现有的 vendorsetup.sh"
        else
          echo 'add_lunch_combo twrp_selene-eng' > device/xiaomi/selene/vendorsetup.sh
          echo "已创建 vendorsetup.sh"
        fi
        
        # 如果设备树不存在，使用我们复制过来的
        if [ ! -d "device/xiaomi/selene" ] || [ -z "$(ls -A device/xiaomi/selene)" ]; then
          echo "设备树为空，使用准备好的文件"
          mkdir -p device/xiaomi/selene
          cp -r ../device/xiaomi/selene/* device/xiaomi/selene/ 2>/dev/null || true
        fi
        
    - name: Build recovery
      run: |
        cd twrp-build
        
        echo "设置构建环境..."
        export ALLOW_MISSING_DEPENDENCIES=true
        export LC_ALL=C
        
        source build/envsetup.sh
        
        if [ -f "device/xiaomi/selene/vendorsetup.sh" ]; then
          source device/xiaomi/selene/vendorsetup.sh
        fi
        
        echo "选择构建目标..."
        lunch twrp_selene-eng || true
        
        echo "开始构建 recovery..."
        make recoveryimage -j$(nproc --all) 2>&1 | tee build.log || {
          echo "构建过程出错，检查日志..."
          tail -100 build.log
        }
        
    - name: Check build results
      run: |
        cd twrp-build
        
        echo "查找构建输出..."
        find out/target/product -name "*.img" -type f 2>/dev/null
        
        if [ -f "out/target/product/selene/recovery.img" ]; then
          echo "✅ 构建成功！"
          ls -lh out/target/product/selene/recovery.img
          
          # 验证镜像文件
          file out/target/product/selene/recovery.img
        else
          echo "❌ 未找到 recovery.img"
          echo "=== 构建日志最后100行 ==="
          tail -100 build.log
          
          echo "=== 可能的构建输出 ==="
          find . -name "*.img" -type f 2>/dev/null | head -10
        fi
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: twrp-recovery
        path: |
          twrp-build/out/target/product/selene/recovery.img
          twrp-build/build.log
        if-no-files-found: ignore
        retention-days: 7
        
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          twrp-build/build.log
          twrp-build/out/error.log
        if-no-files-found: ignore
