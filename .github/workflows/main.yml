# 文件: .github/workflows/build_twrp_fixed.yml
name: Build TWRP Recovery for Dynamic Partition

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
    - name: Checkout device tree
      uses: actions/checkout@v4
      
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git-core python3 python-is-python3 curl \
          openjdk-11-jdk ccache bc libssl-dev \
          android-sdk-libsparse-utils abootimg \
          gperf flex bison build-essential zip \
          zlib1g-dev libncurses5-dev libxml2-utils \
          unzip squashfs-tools python3-pip
        
        curl -s https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
        chmod +x ~/repo
        sed -i '1s/python$/python3/' ~/repo
        
        # 设置ccache
        ccache -M 10G
        
    - name: Prepare build environment
      run: |
        mkdir -p twrp-build
        
        # 创建设备树目录
        mkdir -p twrp-build/device/xiaomi/selene
        
        # 复制设备树文件（排除.git）
        find . -maxdepth 1 -type f -exec cp {} twrp-build/device/xiaomi/selene/ \; 2>/dev/null || true
        find . -mindepth 1 -maxdepth 1 -type d ! -name '.git' ! -name '.github' -exec cp -r {} twrp-build/device/xiaomi/selene/ \; 2>/dev/null || true
        
        # 确保有BoardConfig.mk
        if [ ! -f "twrp-build/device/xiaomi/selene/BoardConfig.mk" ]; then
          echo "❌ 缺少 BoardConfig.mk 文件"
          exit 1
        fi
        
    - name: Clone TWRP sources
      run: |
        cd twrp-build
        
        echo "初始化 TWRP AOSP 12.1 源码..."
        ~/repo init -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git \
          -b twrp-12.1 \
          --depth=1
        
        echo "同步源码..."
        ~/repo sync -c --force-sync --no-clone-bundle --no-tags -j4
        
        echo "源码同步完成"
        
    - name: Setup device configuration
      run: |
        cd twrp-build
        
        # 检查是否为动态分区
        if grep -q "BOARD_USES_RECOVERY_AS_BOOT" device/xiaomi/selene/BoardConfig.mk || \
           grep -q "BOARD_MOVE_RECOVERY_RESOURCES_TO_VENDOR_BOOT" device/xiaomi/selene/BoardConfig.mk; then
          echo "✅ 检测到动态分区配置"
          
          # 确保使用bootimage而不是recoveryimage
          if [ -f "device/xiaomi/selene/AndroidProducts.mk" ]; then
            sed -i 's/recoveryimage/bootimage/g' device/xiaomi/selene/AndroidProducts.mk 2>/dev/null || true
          fi
          
          # 为动态分区创建特定配置
          if [ -f "device/xiaomi/selene/BoardConfig.mk" ]; then
            echo "" >> device/xiaomi/selene/BoardConfig.mk
            echo "# 动态分区配置" >> device/xiaomi/selene/BoardConfig.mk
            echo "BOARD_USES_RECOVERY_AS_BOOT := true" >> device/xiaomi/selene/BoardConfig.mk
            echo "TARGET_NO_RECOVERY := true" >> device/xiaomi/selene/BoardConfig.mk
            echo "TARGET_COPY_OUT_RECOVERY := boot" >> device/xiaomi/selene/BoardConfig.mk
          fi
        else
          echo "⚠️  未检测到动态分区配置，尝试添加标准配置"
          echo "" >> device/xiaomi/selene/BoardConfig.mk
          echo "BOARD_USES_RECOVERY_AS_BOOT := true" >> device/xiaomi/selene/BoardConfig.mk
          echo "TARGET_NO_RECOVERY := true" >> device/xiaomi/selene/BoardConfig.mk
        fi
        
        # 创建vendorsetup.sh
        echo 'add_lunch_combo twrp_selene-eng' > device/xiaomi/selene/vendorsetup.sh
        
    - name: Build TWRP for dynamic partition
      run: |
        cd twrp-build
        
        echo "设置构建环境..."
        export ALLOW_MISSING_DEPENDENCIES=true
        export LC_ALL=C
        export USE_CCACHE=1
        export CCACHE_EXEC=$(which ccache)
        
        source build/envsetup.sh
        
        echo "选择构建目标..."
        lunch twrp_selene-eng
        
        echo "开始构建 TWRP (bootimage)..."
        echo "=========================================="
        
        # 对于动态分区设备，构建 bootimage 包含 recovery
        make bootimage -j$(nproc --all) 2>&1 | tee build.log
        
        echo "=========================================="
        echo "构建完成"
        
    - name: Check and process build output
      run: |
        cd twrp-build
        
        echo "查找构建输出文件..."
        
        # 查找 boot.img（动态分区的 recovery）
        if [ -f "out/target/product/selene/boot.img" ]; then
          echo "✅ 找到 boot.img (包含 TWRP)"
          ls -lh out/target/product/selene/boot.img
          
          # 验证文件类型
          file out/target/product/selene/boot.img
          
          # 重命名为 twrp-<日期>-selene.img 以便识别
          BUILD_DATE=$(date +%Y%m%d-%H%M)
          cp out/target/product/selene/boot.img "out/target/product/selene/twrp-${BUILD_DATE}-selene.img"
          
          echo "已复制为: twrp-${BUILD_DATE}-selene.img"
          
        # 如果生成了 recovery.img（非动态分区）
        elif [ -f "out/target/product/selene/recovery.img" ]; then
          echo "✅ 找到 recovery.img"
          ls -lh out/target/product/selene/recovery.img
          
          BUILD_DATE=$(date +%Y%m%d-%H%M)
          cp out/target/product/selene/recovery.img "out/target/product/selene/twrp-${BUILD_DATE}-selene.img"
          
        else
          echo "❌ 未找到 boot.img 或 recovery.img"
          echo "=== 查找所有镜像文件 ==="
          find out/target/product -name "*.img" -type f 2>/dev/null | xargs ls -lh 2>/dev/null || true
          
          echo "=== 构建日志最后100行 ==="
          tail -100 build.log
          
          # 尝试查找其他可能的输出
          echo "=== 可能的输出目录 ==="
          ls -la out/target/product/*/ 2>/dev/null || true
        fi
        
    - name: Upload TWRP image
      uses: actions/upload-artifact@v4
      with:
        name: twrp-selene
        path: |
          twrp-build/out/target/product/selene/boot.img
          twrp-build/out/target/product/selene/recovery.img
          twrp-build/out/target/product/selene/twrp-*-selene.img
        if-no-files-found: ignore
        retention-days: 7
        
    - name: Upload build logs
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          twrp-build/build.log
        if-no-files-found: ignore
